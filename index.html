<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web UTAU Replica</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }

        #piano-roll-container {
            position: relative;
            width: 90%;
            max-width: 1200px;
            height: 400px;
            border: 1px solid #ccc;
            background-color: #fff;
            overflow-x: scroll;
            cursor: crosshair;
        }

        #piano-roll {
            background-color: #fff;
        }

        .note {
            background-color: #4CAF50;
            border: 1px solid #388E3C;
            position: absolute;
            box-sizing: border-box;
            opacity: 0.8;
            cursor: pointer;
        }

        .selected {
            background-color: #FFC107;
        }

        .note-lyrics {
            color: #fff;
            font-size: 12px;
            padding: 2px;
            position: absolute;
            bottom: -20px;
            left: 0;
            white-space: nowrap;
        }

        #controls {
            margin-top: 20px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
        }

        .hidden {
            display: none;
        }

        #editor-panel {
            margin-top: 20px;
            width: 90%;
            max-width: 1200px;
            border: 1px solid #ccc;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
        }

        .editor-section {
            margin-bottom: 15px;
        }

        .editor-section h3 {
            margin: 0 0 10px 0;
        }

        #pitch-editor, #envelope-editor {
            width: 100%;
            height: 150px;
            border: 1px solid #ccc;
            cursor: crosshair;
            background-color: #fafafa;
        }
    </style>
</head>
<body>

    <header>
        <h1>簡易UTAU Web版</h1>
    </header>

    <main>
        <div id="piano-roll-container">
            <div id="lyrics-input-area"></div>
        </div>
        
        <div id="controls">
            <button id="play-btn">再生</button>
            <button id="stop-btn">停止</button>
        </div>

        <div id="editor-panel" class="hidden">
            <h2>ノート編集</h2>
            <div class="editor-section">
                <h3>ピッチカーブ</h3>
                <canvas id="pitch-editor"></canvas>
            </div>
            <div class="editor-section">
                <h3>エンベロープ</h3>
                <canvas id="envelope-editor"></canvas>
            </div>
            <div class="editor-section">
                <h3>ビブラート</h3>
                <label for="vibrato-depth">深さ:</label>
                <input type="range" id="vibrato-depth" min="0" max="100" value="0">
                <label for="vibrato-rate">速さ:</label>
                <input type="range" id="vibrato-rate" min="0" max="10" step="0.1" value="0">
            </div>
        </div>
    </main>
    
    <script>
        // ====== 設定と初期化 ======
        const NOTE_WIDTH = 50;
        const NOTE_HEIGHT = 20;
        const PITCH_RANGE = 24;
        const PITCH_OFFSET = 60;
        const TEMPO = 120;
        const T_PER_BEAT = 60 / TEMPO;

        let audioContext;
        let masterGain;
        const audioBuffers = {};
        const notes = [];
        const phonemes = ['a', 'i', 'u', 'e', 'o'];
        const noteElements = new Map();

        let isPlaying = false;
        let selectedNote = null;

        // UI要素の取得
        const pianoRollContainer = document.getElementById('piano-roll-container');
        const lyricsInputArea = document.getElementById('lyrics-input-area');
        const playBtn = document.getElementById('play-btn');
        const stopBtn = document.getElementById('stop-btn');
        const editorPanel = document.getElementById('editor-panel');
        const vibratoDepthInput = document.getElementById('vibrato-depth');
        const vibratoRateInput = document.getElementById('vibrato-rate');

        // ====== 音源のロード ======
        async function loadAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            masterGain = audioContext.createGain();
            masterGain.connect(audioContext.destination);

            for (const phoneme of phonemes) {
                try {
                    const response = await fetch(`audio/${phoneme}.wav`);
                    const arrayBuffer = await response.arrayBuffer();
                    audioBuffers[phoneme] = await audioContext.decodeAudioData(arrayBuffer);
                    console.log(`Loaded ${phoneme}.wav`);
                } catch (error) {
                    console.error(`Failed to load ${phoneme}.wav`, error);
                }
            }
        }

        // ====== UIの描画 ======
        function drawPianoRoll() {
            // 背景のグリッドを動的に生成
            const numBeats = Math.max(16, Math.ceil(pianoRollContainer.scrollWidth / NOTE_WIDTH / 4) * 4);
            pianoRollContainer.style.width = `${numBeats * NOTE_WIDTH}px`;
            
            // ノートのHTML要素を更新
            noteElements.forEach(el => el.remove());
            noteElements.clear();

            notes.forEach(note => {
                const noteEl = document.createElement('div');
                noteEl.className = 'note';
                noteEl.style.left = `${note.time * NOTE_WIDTH}px`;
                noteEl.style.top = `${(PITCH_RANGE - 1 - (note.pitch - PITCH_OFFSET)) * NOTE_HEIGHT}px`;
                noteEl.style.width = `${note.duration * NOTE_WIDTH}px`;
                noteEl.style.height = `${NOTE_HEIGHT}px`;

                const lyricsEl = document.createElement('div');
                lyricsEl.className = 'note-lyrics';
                lyricsEl.textContent = note.phoneme;
                noteEl.appendChild(lyricsEl);

                pianoRollContainer.appendChild(noteEl);
                noteElements.set(note, noteEl);
            });
            updateSelection();
        }

        function updateSelection() {
            noteElements.forEach((el, note) => {
                if (note === selectedNote) {
                    el.classList.add('selected');
                } else {
                    el.classList.remove('selected');
                }
            });
        }

        // ====== ノートの追加と選択 ======
        pianoRollContainer.addEventListener('click', (e) => {
            if (isPlaying) return;

            const rect = pianoRollContainer.getBoundingClientRect();
            const x = e.clientX - rect.left + pianoRollContainer.scrollLeft;
            const y = e.clientY - rect.top;

            const clickedNoteEl = e.target.closest('.note');
            if (clickedNoteEl) {
                const note = Array.from(noteElements.keys()).find(key => noteElements.get(key) === clickedNoteEl);
                if (note) {
                    selectedNote = note;
                    showEditorPanel();
                    updateSelection();
                }
            } else {
                const time = Math.floor(x / NOTE_WIDTH);
                const pitchIndex = Math.floor(y / NOTE_HEIGHT);
                const pitch = PITCH_RANGE - 1 - pitchIndex + PITCH_OFFSET;

                const phoneme = prompt('歌詞を入力してください (例: a, i, u, e, o)', 'a');
                if (phoneme && phonemes.includes(phoneme)) {
                    notes.push({
                        time: time,
                        pitch: pitch,
                        duration: 1,
                        phoneme: phoneme,
                        envelope: { attack: 0.1, decay: 0.1, sustain: 0.8, release: 0.2 },
                        vibrato: { depth: 0, rate: 0 },
                        pitchBend: [{ time: 0, value: 0 }, { time: 1, value: 0 }]
                    });
                    notes.sort((a, b) => a.time - b.time);
                    drawPianoRoll();
                }
            }
        });

        // ====== エディタパネル ======
        function showEditorPanel() {
            if (!selectedNote) return;
            editorPanel.classList.remove('hidden');
            updateVibratoInputs();
        }

        function updateVibratoInputs() {
            vibratoDepthInput.value = selectedNote.vibrato.depth;
            vibratoRateInput.value = selectedNote.vibrato.rate;
        }

        vibratoDepthInput.addEventListener('input', () => {
            if (selectedNote) {
                selectedNote.vibrato.depth = parseFloat(vibratoDepthInput.value);
            }
        });

        vibratoRateInput.addEventListener('input', () => {
            if (selectedNote) {
                selectedNote.vibrato.rate = parseFloat(vibratoRateInput.value);
            }
        });

        // ====== 再生機能 ======
        function playNote(note, time) {
            if (!audioBuffers[note.phoneme]) return;

            const source = audioContext.createBufferSource();
            source.buffer = audioBuffers[note.phoneme];

            const gainNode = audioContext.createGain();
            const pitchShifter = audioContext.createGain();

            source.connect(pitchShifter);
            pitchShifter.connect(gainNode);
            gainNode.connect(masterGain);

            const noteDuration = note.duration * T_PER_BEAT;
            const now = audioContext.currentTime;

            // エンベロープ
            const attackEnd = now + time + note.envelope.attack * noteDuration;
            const releaseStart = now + time + noteDuration - note.envelope.release * noteDuration;
            
            gainNode.gain.setValueAtTime(0, now + time);
            gainNode.gain.linearRampToValueAtTime(1, attackEnd);
            gainNode.gain.setValueAtTime(note.envelope.sustain, attackEnd);
            gainNode.gain.linearRampToValueAtTime(0, releaseStart + note.envelope.release * noteDuration);

            // ピッチカーブ
            note.pitchBend.forEach(point => {
                const bendTime = now + time + point.time * noteDuration;
                const bendValue = Math.pow(2, point.value / 1200);
                source.playbackRate.linearRampToValueAtTime(Math.pow(2, (note.pitch - 60) / 12) * bendValue, bendTime);
            });

            // ビブラート
            if (note.vibrato.depth > 0 && note.vibrato.rate > 0) {
                const lfo = audioContext.createOscillator();
                const lfoGain = audioContext.createGain();

                lfo.type = 'sine';
                lfo.frequency.setValueAtTime(note.vibrato.rate, now + time);
                lfoGain.gain.setValueAtTime(note.vibrato.depth, now + time);

                lfo.connect(lfoGain);
                lfoGain.connect(source.playbackRate);

                lfo.start(now + time);
                lfo.stop(now + time + noteDuration);
            }
            
            source.start(now + time);
            source.stop(now + time + noteDuration);
        }

        function scheduleNotes() {
            const now = audioContext.currentTime;
            notes.forEach(note => {
                const noteStartTime = now + note.time * T_PER_BEAT;
                playNote(note, noteStartTime);
            });
        }

        playBtn.addEventListener('click', () => {
            if (isPlaying) return;
            isPlaying = true;
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            scheduleNotes();
            console.log('再生開始');
        });

        stopBtn.addEventListener('click', () => {
            if (!isPlaying) return;
            isPlaying = false;
            masterGain.disconnect();
            masterGain = audioContext.createGain();
            masterGain.connect(audioContext.destination);
            console.log('再生停止');
        });

        // 初期化
        loadAudio().then(() => {
            drawPianoRoll();
            window.addEventListener('resize', drawPianoRoll);
        });
    </script>
</body>
</html>
